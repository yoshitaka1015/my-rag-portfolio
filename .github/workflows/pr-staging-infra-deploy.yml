# .github/workflows/pr-infra-pipeline.yml

name: Deploy Infrastructure to Staging on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'terraform/**'

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  deploy-infra-preview:
    name: Deploy Infrastructure to Staging
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/150327319937/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-runner@serious-timer-467517-e1.iam.gserviceaccount.com'

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Deploy to Staging
        run: |
          cd terraform
          terraform init -input=false -reconfigure
          terraform workspace select staging || terraform workspace new staging
          terraform apply -var-file="staging.tfvars" -auto-approve
      
      # --- â–¼ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€â–¼ ---

      # ã‚¹ãƒ†ãƒƒãƒ—1: Terraformã®å‡ºåŠ›ã‚’å–å¾—ã—ã€ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›å¤‰æ•°ã«è¨­å®šã™ã‚‹
      - name: Get Preview URL
        id: get_url
        run: |
          cd terraform
          echo "app_url=$(terraform output -raw rag_app_url)" >> $GITHUB_OUTPUT
        
      # ã‚¹ãƒ†ãƒƒãƒ—2: å–å¾—ã—ãŸURLã‚’ä½¿ã£ã¦ã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹
      - name: Post Preview URL to PR Comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = "${{ steps.get_url.outputs.app_url }}";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸš€ **Infrastructure Preview Deployed!**\n\nAccess it here: ${url}`
            });